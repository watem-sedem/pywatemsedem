<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pywatemsedem.geo.utils &mdash; pywatemsedem 0.0.1a7.post1.dev2+g7739a78 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=fbdb9ebb" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/documentation_options.js?v=dd886e4b"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../_static/copybutton.js?v=f281be69"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            pywatemsedem
          </a>
              <div class="version">
                0.0.1a7.post1.dev2+g7739a78
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">pywatemsedem</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">Module Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/api.html">Data processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/calibrate.html">Calibrating WaTEM/SEDEM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/geo.html">Processing rasters and vector</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/userchoices.html">User Choices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting-started/io.html">IO</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Development guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html#package-release">Package release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../codeofconduct.html">Code of conduct</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pywatemsedem</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pywatemsedem.geo.utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pywatemsedem.geo.utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># Standard libraries</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">fiona</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">from</span> <span class="nn">rasterio.features</span> <span class="kn">import</span> <span class="n">shapes</span>
<span class="kn">from</span> <span class="nn">rasterio.merge</span> <span class="kn">import</span> <span class="n">merge</span>

<span class="kn">from</span> <span class="nn">pywatemsedem.geo.rasterproperties</span> <span class="kn">import</span> <span class="n">RasterProperties</span>

<span class="kn">from</span> <span class="nn">..defaults</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">SAGA_FLAGS</span><span class="p">,</span>
    <span class="n">SUFFIXES_RST</span><span class="p">,</span>
    <span class="n">SUFFIXES_SAGA</span><span class="p">,</span>
    <span class="n">SUFFIXES_SHP</span><span class="p">,</span>
    <span class="n">SUFFIXES_TIF</span><span class="p">,</span>
    <span class="n">SUFFIXES_TXT</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.valid</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">valid_input</span><span class="p">,</span>
    <span class="n">valid_linesvector</span><span class="p">,</span>
    <span class="n">valid_pointvector</span><span class="p">,</span>
    <span class="n">valid_polygonvector</span><span class="p">,</span>
    <span class="n">valid_raster</span><span class="p">,</span>
    <span class="n">valid_rasterlist</span><span class="p">,</span>
    <span class="n">valid_vector</span><span class="p">,</span>
    <span class="n">valid_vectorlist</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="check_rst_dimensions">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.check_rst_dimensions">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">check_rst_dimensions</span><span class="p">(</span><span class="n">rst_in</span><span class="p">,</span> <span class="n">minmax</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function checks if the input raster has the desired dimensions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_in: str</span>
<span class="sd">        File path to input raster</span>
<span class="sd">    minmax: list</span>
<span class="sd">        Containing xmin, ymin, xmax, ymax</span>
<span class="sd">    ncols: int</span>
<span class="sd">        Number of columns in the raster</span>
<span class="sd">    nrows: int</span>
<span class="sd">        Number of rows in the raster</span>
<span class="sd">    transform:  rasterio.transform, default None</span>
<span class="sd">        Transformation as defined in Rasterio.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Raster has the required dimensions (True/False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">coordinates</span><span class="p">,</span> <span class="n">transf</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">read_rst_params</span><span class="p">(</span><span class="n">rst_in</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cols</span> <span class="o">!=</span> <span class="n">ncols</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">elif</span> <span class="n">rows</span> <span class="o">!=</span> <span class="n">nrows</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">elif</span> <span class="n">minmax</span> <span class="o">!=</span> <span class="n">coordinates</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">elif</span> <span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">transf</span> <span class="o">!=</span> <span class="n">transform</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="read_rst_params">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.read_rst_params">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">read_rst_params</span><span class="p">(</span><span class="n">rst_in</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read all spatial dimensions of a raster</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_in: pathlib.Path</span>
<span class="sd">        File path to the input raster</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    minmax: list</span>
<span class="sd">        A list with the extreme coordinate values (xmin, ymin, xmax and ymax)</span>
<span class="sd">    transform: rasterio.transform</span>
<span class="sd">        Transformation as defined in Rasterio.</span>
<span class="sd">    cols: int</span>
<span class="sd">        The number of columns in the raster</span>
<span class="sd">    rows: int</span>
<span class="sd">        The number of rows in the raster</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rst_in</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">width</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">height</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">transf</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">transform</span>
        <span class="n">minmax</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">minmax</span><span class="p">,</span> <span class="n">transf</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span></div>



<div class="viewcode-block" id="read_dtype_raster">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.read_dtype_raster">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">read_dtype_raster</span><span class="p">(</span><span class="n">rst_in</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read dtype of raster</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_in: pathlib.Path</span>
<span class="sd">        File path to the input raster</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dtype: numpy.dtype</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>
<span class="sd">    Only works for single band rasters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rst_in</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span></div>



<div class="viewcode-block" id="read_rasterio_profile">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.read_rasterio_profile">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">read_rasterio_profile</span><span class="p">(</span><span class="n">rst_in</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read all spatial dimensions of a raster</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_in: pathlib.Path</span>
<span class="sd">        File path to the input raster</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    profile: dict</span>
<span class="sd">        See :func:`pywatemsedem.geo.rasterproperties.RasterProperties.rasterio_profile`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rst_in</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span>

    <span class="k">return</span> <span class="n">profile</span></div>



<div class="viewcode-block" id="write_arr_as_rst">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.write_arr_as_rst">[docs]</a>
<span class="k">def</span> <span class="nf">write_arr_as_rst</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">rst_out</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write numpy.ndarray as a raster-file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr: numpy.ndarray</span>
<span class="sd">        2D numpy array to be written as a raster file</span>
<span class="sd">    rst_out: str</span>
<span class="sd">        File path to the output raster</span>
<span class="sd">    dtype: numpy.dtype</span>
<span class="sd">    profile: rasterio.profiles</span>
<span class="sd">        See :class:`rasterio.profiles.Profile`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mandatorykeys</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;driver&quot;</span><span class="p">,</span>
        <span class="s2">&quot;height&quot;</span><span class="p">,</span>
        <span class="s2">&quot;width&quot;</span><span class="p">,</span>
        <span class="s2">&quot;crs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;transform&quot;</span><span class="p">,</span>
        <span class="s2">&quot;count&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nodata&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mandatorykeys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;not all mandatory keys in the profile are given! &quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="n">key</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;compress&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">profile</span><span class="p">:</span>
        <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;compress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DEFLATE&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;dtype&quot;</span> <span class="ow">in</span> <span class="n">profile</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">check_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;no valid dtype chosen! </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;dimensions of array are not the same of the given profile&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rst_out</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">)</span> <span class="k">as</span> <span class="n">dst</span><span class="p">:</span>
        <span class="n">dst</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>



<div class="viewcode-block" id="check_raster_properties_raster_with_template">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.check_raster_properties_raster_with_template">[docs]</a>
<span class="k">def</span> <span class="nf">check_raster_properties_raster_with_template</span><span class="p">(</span><span class="n">path_check</span><span class="p">,</span> <span class="n">path_template</span><span class="p">,</span> <span class="n">epsg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if extent and resolution of new raster and template raster align</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path_check: pathlib.Path | RasterProperties</span>
<span class="sd">                Incoming, new raster</span>
<span class="sd">    path_template: pathlib.Path</span>
<span class="sd">                    Template raster</span>
<span class="sd">    epsg: int</span>
<span class="sd">            EPSG code of the cartographic projection</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_check</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">rp_check</span> <span class="o">=</span> <span class="n">RasterProperties</span><span class="o">.</span><span class="n">from_rasterio</span><span class="p">(</span>
            <span class="n">read_rasterio_profile</span><span class="p">(</span><span class="n">path_check</span><span class="p">),</span> <span class="n">epsg</span><span class="o">=</span><span class="n">epsg</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rp_check</span> <span class="o">=</span> <span class="n">path_check</span>

    <span class="n">rp_template</span> <span class="o">=</span> <span class="n">RasterProperties</span><span class="o">.</span><span class="n">from_rasterio</span><span class="p">(</span>
        <span class="n">read_rasterio_profile</span><span class="p">(</span><span class="n">path_template</span><span class="p">),</span> <span class="n">epsg</span><span class="o">=</span><span class="n">epsg</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">rp_check</span><span class="o">.</span><span class="n">bounds</span> <span class="o">!=</span> <span class="n">rp_template</span><span class="o">.</span><span class="n">bounds</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Extent of new raster not the same as of template raster&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">rp_check</span><span class="o">.</span><span class="n">resolution</span> <span class="o">!=</span> <span class="n">rp_template</span><span class="o">.</span><span class="n">resolution</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Resolution of new raster not the same as of template raster&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="grid_difference">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.grid_difference">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst_in1&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">,</span> <span class="s2">&quot;rst_in2&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">grid_difference</span><span class="p">(</span><span class="n">rst_in1</span><span class="p">,</span> <span class="n">rst_in2</span><span class="p">,</span> <span class="n">rst_out</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make the difference between two grids</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_in1: str</span>
<span class="sd">        File path to inputraster 1</span>
<span class="sd">    rst_in2: str</span>
<span class="sd">        File path to inputraster 2</span>
<span class="sd">    rst_out: str</span>
<span class="sd">        File path to outputraster</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;saga_cmd&quot;</span><span class="p">,</span> <span class="n">SAGA_FLAGS</span><span class="p">,</span> <span class="s2">&quot;grid_calculus&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-A&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_in1</span><span class="p">),</span> <span class="s2">&quot;-B&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_in2</span><span class="p">),</span> <span class="s2">&quot;-C&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_out</span><span class="p">)]</span>

    <span class="n">execute_saga</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_hillshade">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.create_hillshade">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">create_hillshade</span><span class="p">(</span><span class="n">rst_in</span><span class="p">,</span> <span class="n">rst_hillshade</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a hillshade raster of the DTM</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_in: str</span>
<span class="sd">        File path of input raster</span>
<span class="sd">    rst_hillshade: str</span>
<span class="sd">        File path of output raster</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rst_hillshade</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">rst_hillshade</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">rst_hillshade</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">rst_hillshade</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rst_hillshade</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">rst_hillshade</span> <span class="o">=</span> <span class="n">rst_hillshade</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="n">rst_hillshade</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;hillshade&#39; is of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">rst_hillshade</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;cannot be converted to Pathlib Path&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gdaldem&quot;</span><span class="p">,</span> <span class="s2">&quot;hillshade&quot;</span><span class="p">,</span> <span class="s2">&quot;-q&quot;</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-co&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPRESS=DEFLATE&quot;</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">rst_in</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_hillshade</span><span class="p">)]</span>
    <span class="n">execute_subprocess</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_fields_vct">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.get_fields_vct">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct&quot;</span><span class="p">:</span> <span class="n">valid_vector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">get_fields_vct</span><span class="p">(</span><span class="n">vct</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a list of all fields in a shapefile</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct: str</span>
<span class="sd">        File path to shapefile</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Field names of the shape/vector-file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vct</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fields</span></div>



<div class="viewcode-block" id="get_geometry_type">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.get_geometry_type">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct&quot;</span><span class="p">:</span> <span class="n">valid_vector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">get_geometry_type</span><span class="p">(</span><span class="n">vct</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the geometry type of a shapefile</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct: str</span>
<span class="sd">        File path to shapefile</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Geometry type (see fiona documentation for all possibilities)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vct</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">geom</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">schema</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">geom</span></div>



<div class="viewcode-block" id="copy_rst">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.copy_rst">[docs]</a>
<span class="k">def</span> <span class="nf">copy_rst</span><span class="p">(</span><span class="n">rst_in</span><span class="p">,</span> <span class="n">rt_out</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Copy a raster and converts it to an idrisi-raster</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_in: str</span>
<span class="sd">        File path of input raster</span>
<span class="sd">    rt_out: str</span>
<span class="sd">        File path of output raster (extension must be .rst!)</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>
<span class="sd">    Uses and relies on gdal_translate CLI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rt_out</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">delete_rst</span><span class="p">(</span><span class="n">rt_out</span><span class="p">)</span>

    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gdal_translate&quot;</span><span class="p">,</span> <span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="s2">&quot;-of&quot;</span><span class="p">,</span> <span class="s2">&quot;RST&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_in</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">rt_out</span><span class="p">)]</span>
    <span class="n">execute_subprocess</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="copy_vct">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.copy_vct">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct_in&quot;</span><span class="p">:</span> <span class="n">valid_vector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">copy_vct</span><span class="p">(</span><span class="n">vct_in</span><span class="p">,</span> <span class="n">folder_out</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Copies a shapefile to another location</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct_in: str or pathlib.Path</span>
<span class="sd">        File path of the shapefile to be copied.</span>
<span class="sd">    folder_out: str or pathlib.Path</span>
<span class="sd">        File path of the destination shapefile.</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>
<span class="sd">    Uses and relies on ogr2ogr CLI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ogr2ogr&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">folder_out</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_in</span><span class="p">)]</span>
    <span class="n">execute_subprocess</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="tiff_to_esri_shp">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.tiff_to_esri_shp">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tiff_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">tiff_to_esri_shp</span><span class="p">(</span><span class="n">tiff_in</span><span class="p">,</span> <span class="n">vct_out</span><span class="p">,</span> <span class="n">epsg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transform a tiff file to an esri shape (raster to shape)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tiff_in: str or pathlib.Path</span>
<span class="sd">        name input tiff</span>
<span class="sd">    vct_out: str or pathlib.Path</span>
<span class="sd">        name input shapefile</span>
<span class="sd">    epsg: str, default None</span>
<span class="sd">        the epsg code defining the coordinate system of the raster,</span>
<span class="sd">        format = &quot;EPSG:XXXXX&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gpd_db</span> <span class="o">=</span> <span class="n">tiff_to_geopandas_df</span><span class="p">(</span><span class="n">tiff_in</span><span class="p">,</span> <span class="n">epsg</span><span class="p">)</span>
    <span class="n">gpd_db</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">vct_out</span><span class="p">))</span></div>



<div class="viewcode-block" id="tiff_to_geopandas_df">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.tiff_to_geopandas_df">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tiff_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">tiff_to_geopandas_df</span><span class="p">(</span><span class="n">tiff_in</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform a tiff file to a geopandas dataframe</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tiff_in: str or pathlib.Path</span>
<span class="sd">        File path of tiff raster file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    gdf: geopandas.GeoDataFrame</span>
<span class="sd">        Geopandas representation of tiff raster</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tiff_in</span><span class="p">))</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">crs</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;profile&quot;</span><span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">},</span> <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">geometry</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">geometry</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="n">shapes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;transform&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">geoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="o">.</span><span class="n">from_features</span><span class="p">(</span><span class="n">geoms</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gdf</span></div>



<div class="viewcode-block" id="idrisi_to_tiff">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.idrisi_to_tiff">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">idrisi_to_tiff</span><span class="p">(</span><span class="n">rst_in</span><span class="p">,</span> <span class="n">tiff_out</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">epsg</span><span class="o">=</span><span class="s2">&quot;EPSG:31370&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert an Idrisi RST to GeoTiff</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_in: str</span>
<span class="sd">        File path of the input rst.</span>
<span class="sd">    tiff_out: str</span>
<span class="sd">        File path of the output tiff file.</span>
<span class="sd">    dtype: str</span>
<span class="sd">        Data type of the destination rst, either &#39;integer&#39; or &#39;float&#39;.</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>
<span class="sd">    Uses and relies on gdal_translate CLI</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;integer&quot;</span><span class="p">:</span>
        <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;gdal_translate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-q&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-ot&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Int16&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-of&quot;</span><span class="p">,</span>
            <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-co&quot;</span><span class="p">,</span>
            <span class="s2">&quot;COMPRESS=DEFLATE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-a_srs&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">epsg</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">rst_in</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">tiff_out</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">execute_subprocess</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;float&quot;</span><span class="p">:</span>
        <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;gdal_translate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-q&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-ot&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Float32&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-of&quot;</span><span class="p">,</span>
            <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-co&quot;</span><span class="p">,</span>
            <span class="s2">&quot;COMPRESS=DEFLATE&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-a_srs&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">epsg</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">rst_in</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">tiff_out</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">execute_subprocess</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Saving rst as tif. Type must be &quot;integer&quot; or &quot;float&quot;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="valid_gdal_type">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.valid_gdal_type">[docs]</a>
<span class="k">def</span> <span class="nf">valid_gdal_type</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if your input array mask is valid. Use as decorator&quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper function</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        *args:</span>
<span class="sd">            non keyword arguments</span>
<span class="sd">        dtype: numpy.dtype or str</span>
<span class="sd">            allowed types are &quot;Float32&quot;, &quot;Float64&quot;, &quot;Int16&quot;, &quot;Int32&quot;, &quot;Int64&quot;</span>
<span class="sd">            integer is Int16, float is Float32</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;integer&quot;</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;Int16&quot;</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;float&quot;</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="s2">&quot;Float32&quot;</span>
        <span class="n">implemented_types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Float32&quot;</span><span class="p">,</span> <span class="s2">&quot;Float64&quot;</span><span class="p">,</span> <span class="s2">&quot;Int16&quot;</span><span class="p">,</span> <span class="s2">&quot;Int32&quot;</span><span class="p">,</span> <span class="s2">&quot;Int64&quot;</span><span class="p">]</span>
        <span class="c1"># check value dtype and if not string</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">name</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">implemented_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Raster type </span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> not known for gdal, please select &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">implemented_types</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span></div>



<div class="viewcode-block" id="tiff_to_idrisi">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.tiff_to_idrisi">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tiff_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="nd">@valid_gdal_type</span>
<span class="k">def</span> <span class="nf">tiff_to_idrisi</span><span class="p">(</span><span class="n">tiff_in</span><span class="p">,</span> <span class="n">rst_out</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a GeoTiff to an Idrisi RST</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tiff_in: str</span>
<span class="sd">        File path of the input tiff file</span>
<span class="sd">    rst_out: str</span>
<span class="sd">        File path of the destination rst</span>
<span class="sd">    dtype: str, default Float64</span>
<span class="sd">        Raster type</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Uses and relies on gdal_translate CLI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;gdal_translate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-q&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-ot&quot;</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span>
        <span class="s2">&quot;-of&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RST&quot;</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">tiff_in</span><span class="p">),</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">rst_out</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">execute_subprocess</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_feature_count">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.get_feature_count">[docs]</a>
<span class="k">def</span> <span class="nf">get_feature_count</span><span class="p">(</span><span class="n">vct</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Count the amount of features in a shapefile</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct: str</span>
<span class="sd">        File path of the shapefile.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nr_features: int</span>
<span class="sd">        Number of features in the shapefile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vct</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">nr_features</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nr_features</span></div>



<div class="viewcode-block" id="merge_lst_vct">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.merge_lst_vct">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lst_vct&quot;</span><span class="p">:</span> <span class="n">valid_vectorlist</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">merge_lst_vct</span><span class="p">(</span><span class="n">lst_vct</span><span class="p">,</span> <span class="n">vct_out</span><span class="p">,</span> <span class="n">epsg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge a list of shapefiles to one shapefile</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lst_vct: list</span>
<span class="sd">        List with file paths (str) of all shapefiles to be merged.</span>
<span class="sd">    vct_out: str</span>
<span class="sd">        File path of merged vct</span>
<span class="sd">    epsg: str</span>
<span class="sd">        The epsg code defining the coordinate system of the raster,</span>
<span class="sd">        format = &quot;EPSG:XXXXX&quot;</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Uses and relies on ogr2ogr CLI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst_vct</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">copy_vct</span><span class="p">(</span><span class="n">vct</span><span class="p">,</span> <span class="n">vct_out</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ogr2ogr&quot;</span><span class="p">,</span> <span class="s2">&quot;-update&quot;</span><span class="p">,</span> <span class="s2">&quot;-a_srs&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">epsg</span><span class="p">)]</span>
            <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-append&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_out</span><span class="p">)]</span>
            <span class="n">cmd_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">vct</span><span class="p">))</span>
            <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-nln&quot;</span><span class="p">,</span> <span class="n">vct_out</span><span class="o">.</span><span class="n">stem</span><span class="p">]</span>

            <span class="n">execute_subprocess</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="merge_lst_vct_saga">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.merge_lst_vct_saga">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lst_vct&quot;</span><span class="p">:</span> <span class="n">valid_vectorlist</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">merge_lst_vct_saga</span><span class="p">(</span><span class="n">lst_vct</span><span class="p">,</span> <span class="n">vct_out</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge a list of shapefiles to one shapefile</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lst_vct: list</span>
<span class="sd">        List with file paths (str) of all shapefiles to be merged.</span>
<span class="sd">    vct_out: str</span>
<span class="sd">        File path + name of the destination shapefile.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Uses and relies on ogr2ogr CLI</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;saga_cmd&quot;</span><span class="p">,</span> <span class="n">SAGA_FLAGS</span><span class="p">,</span> <span class="s2">&quot;shapes_tools&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;-INPUT=</span><span class="si">{</span><span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lst_vct</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;-MERGED=</span><span class="si">{</span><span class="n">vct_out</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">execute_saga</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="delete_rst">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.delete_rst">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">delete_rst</span><span class="p">(</span><span class="n">rst_in</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete a raster dataset</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_in: str</span>
<span class="sd">        File path of the raster dataset to be deleted</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gdalmanage&quot;</span><span class="p">,</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_in</span><span class="p">)]</span>
    <span class="n">execute_subprocess</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="clip_rst">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.clip_rst">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">clip_rst</span><span class="p">(</span><span class="n">rst_in</span><span class="p">,</span> <span class="n">rst_out</span><span class="p">,</span> <span class="n">Cnst</span><span class="p">,</span> <span class="n">resampling</span><span class="o">=</span><span class="s2">&quot;near&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clips a raster to a certain bounding box with a given resolution</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_in: str</span>
<span class="sd">        File path to in input raster.</span>
<span class="sd">    rst_out: str</span>
<span class="sd">        File path to the destination raster.</span>
<span class="sd">    Cnst: dict</span>
<span class="sd">        Dictionary with following keys:</span>

<span class="sd">        - *epsg* (str): the EPSG-code of the rst_in</span>
<span class="sd">        - *res* (int): resolution</span>
<span class="sd">        - *nodata* (int): nodata flag</span>
<span class="sd">        - *minmax* (list): list with xmin, ymin, xmax, ymax</span>
<span class="sd">    resampling: str, default &#39;near&#39;</span>
<span class="sd">        Either &quot;mode&quot; or &quot;near&quot;</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    1. &quot;mode&quot; and &quot;near&quot; have been tested, see</span>
<span class="sd">        https://gdal.org/programs/gdalwarp.html#cmdoption-gdalwarp-r</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rst_in</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">rst_in</span><span class="p">)</span>
    <span class="n">rst_out</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">rst_out</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clipping </span><span class="si">{</span><span class="n">rst_in</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gdalwarp&quot;</span><span class="p">,</span> <span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="s2">&quot;-s_srs&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Cnst</span><span class="p">[</span><span class="s2">&quot;epsg&quot;</span><span class="p">])]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-t_srs&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Cnst</span><span class="p">[</span><span class="s2">&quot;epsg&quot;</span><span class="p">])]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-te&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">oor</span> <span class="ow">in</span> <span class="n">Cnst</span><span class="p">[</span><span class="s2">&quot;minmax&quot;</span><span class="p">]:</span>
        <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">oor</span><span class="p">)]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-tr&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Cnst</span><span class="p">[</span><span class="s2">&quot;res&quot;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">Cnst</span><span class="p">[</span><span class="s2">&quot;res&quot;</span><span class="p">])]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-r&quot;</span><span class="p">,</span> <span class="n">resampling</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">rst_in</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_out</span><span class="p">)]</span>
    <span class="n">execute_subprocess</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_extent_vct">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.get_extent_vct">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct&quot;</span><span class="p">:</span> <span class="n">valid_vector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">get_extent_vct</span><span class="p">(</span><span class="n">vct</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets the bounding box coordinates of a shapefile</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct: str or pathlib.Path</span>
<span class="sd">        File path of the input shapefile.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        xmin, ymin, xmax, ymax</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vct</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">bounds</span>
    <span class="k">return</span> <span class="n">extent</span>  <span class="c1"># xmin, ymin, xmax, ymax</span></div>



<div class="viewcode-block" id="clip_vct">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.clip_vct">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct&quot;</span><span class="p">:</span> <span class="n">valid_vector</span><span class="p">,</span> <span class="s2">&quot;vct_clip&quot;</span><span class="p">:</span> <span class="n">valid_vector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">clip_vct</span><span class="p">(</span><span class="n">vct_in</span><span class="p">,</span> <span class="n">vct_out</span><span class="p">,</span> <span class="n">vct_clip</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lst_ignore_field</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clip a shapefile by another shapefile</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct_in: pathlib.Path</span>
<span class="sd">        File path of shapefile to be clipped.</span>
<span class="sd">    vct_out: pathlib.Path</span>
<span class="sd">        File path of the destination shapefile</span>
<span class="sd">    vct_clip: str</span>
<span class="sd">        File path of the clip boundary vector</span>
<span class="sd">    overwrite: bool, default False</span>
<span class="sd">        If True, overwrite existing file</span>
<span class="sd">    lst_ignore_field: list, optional</span>
<span class="sd">        Ignore a specific field from input in output.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Uses and relies on ogr2ogr CLI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vct_out</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">cond</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clipping </span><span class="si">{</span><span class="n">vct_in</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">get_extent_vct</span><span class="p">(</span><span class="n">vct_clip</span><span class="p">)</span>
        <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;ogr2ogr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-spat&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
        <span class="p">]</span>
        <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-skipfailures&quot;</span><span class="p">]</span>
        <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-clipsrc&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_clip</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">lst_ignore_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">get_fields_vct</span><span class="p">(</span><span class="n">vct_in</span><span class="p">)</span>
            <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="s2">&quot;-select&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lst_ignore_field</span><span class="p">]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vct_out</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_in</span><span class="p">)]</span>
        <span class="n">execute_subprocess</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="compute_statistics_rasters_per_polygon_vector">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.compute_statistics_rasters_per_polygon_vector">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lst_rasters&quot;</span><span class="p">:</span> <span class="n">valid_rasterlist</span><span class="p">,</span> <span class="s2">&quot;vct_polygon&quot;</span><span class="p">:</span> <span class="n">valid_vector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">compute_statistics_rasters_per_polygon_vector</span><span class="p">(</span>
    <span class="n">lst_rasters</span><span class="p">,</span>
    <span class="n">vct_polygon</span><span class="p">,</span>
    <span class="n">vct_out</span><span class="p">,</span>
    <span class="n">lst_names</span><span class="p">,</span>
    <span class="n">dict_operators</span><span class="p">,</span>
    <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">ton</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute statistics</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lst_rasters: list</span>
<span class="sd">        File path rasters (pathlib.Path)</span>
<span class="sd">    vct_polygon: str</span>
<span class="sd">        File path to input polygon vector.</span>
<span class="sd">    vct_out: str</span>
<span class="sd">        File path to output polygon vector.</span>
<span class="sd">    lst_names: dict</span>
<span class="sd">        List of output names in output vector for files in lst_rasters.</span>
<span class="sd">    dict_operators: dict</span>
<span class="sd">        Operators. For a description of the dictionary of statistics, see</span>
<span class="sd">        inputs in :func:`pywatemsedem.geo.utils.grid_statistics`. See example for use.</span>
<span class="sd">    normalize: bool, default False</span>
<span class="sd">        Normalize with shape area (True)</span>
<span class="sd">    ton: bool, default False</span>
<span class="sd">        Use ton (true)</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    The desired statistics are inputted after the file reference of the raster, and are</span>
<span class="sd">    formatted as a dictionary, e.g.:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        dict_operators = {&quot;COUNT&quot;:True,&quot;SUM&quot;:True}</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; vct_aho = &quot;AHO.shp&quot;</span>
<span class="sd">    &gt;&gt;&gt; vct_out = &quot;statistics_aho.shp&quot;</span>
<span class="sd">    &gt;&gt;&gt; rst_sewerin =&quot;sewerin.rst&quot;</span>
<span class="sd">    &gt;&gt;&gt; rst_sediexport =&quot;SediExport.rst&quot;</span>
<span class="sd">    &gt;&gt;&gt; compute_statistics_rasters_per_polygon_vector(vct_aho,</span>
<span class="sd">    &gt;&gt;&gt;                                                   vct_out,</span>
<span class="sd">    &gt;&gt;&gt;                                                   [rst_sewerin,rst_sediexport]</span>
<span class="sd">    &gt;&gt;&gt;                                                   [&quot;River&quot;,&quot;Sewers&quot;],</span>
<span class="sd">    &gt;&gt;&gt;                                                   {&quot;COUNT&quot;:True,&quot;SUM&quot;:True},</span>
<span class="sd">    &gt;&gt;&gt;                                                   ton = True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grid_statistics</span><span class="p">(</span><span class="n">lst_rasters</span><span class="p">,</span> <span class="n">vct_polygon</span><span class="p">,</span> <span class="n">vct_out</span><span class="p">,</span> <span class="o">**</span><span class="n">dict_operators</span><span class="p">)</span>

    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vct_out</span><span class="p">)</span>
    <span class="n">rename</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sa">f</span><span class="s2">&quot;G</span><span class="si">{</span><span class="n">ind</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="n">name</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst_names</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">dict_operators</span>
    <span class="p">}</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">rename</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">lst_names</span><span class="p">:</span>
        <span class="n">gdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">ton</span><span class="p">:</span>
            <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.0</span>
        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">gdf</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s2">&quot;_ha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">area</span><span class="p">)</span>

    <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">vct_out</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gdf</span></div>



<div class="viewcode-block" id="rst_to_vct_points">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.rst_to_vct_points">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">rst_to_vct_points</span><span class="p">(</span><span class="n">rst_in</span><span class="p">,</span> <span class="n">vct_out</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert all no nodata values in a raster to a vector point file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_in: str or pathlib.Path</span>
<span class="sd">        File path of the raster file that should be converted to a shapefile.</span>
<span class="sd">    vct_out: pathlib.Path</span>
<span class="sd">        File path of the destination vct.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;saga_cmd&quot;</span><span class="p">,</span> <span class="n">SAGA_FLAGS</span><span class="p">,</span> <span class="s2">&quot;shapes_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-GRIDS&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_in</span><span class="p">)]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-SHAPES&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_out</span><span class="p">)]</span>
    <span class="n">execute_saga</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="vct_to_rst_value">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.vct_to_rst_value">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct_in&quot;</span><span class="p">:</span> <span class="n">valid_vector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">vct_to_rst_value</span><span class="p">(</span>
    <span class="n">vct_in</span><span class="p">,</span> <span class="n">rst_out</span><span class="p">,</span> <span class="n">rstval</span><span class="p">,</span> <span class="n">Cnst</span><span class="p">,</span> <span class="n">nodata</span><span class="o">=-</span><span class="mi">9999</span><span class="p">,</span> <span class="n">alltouched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rasterizes a shapefile by a given constant value</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct_in: str or pathlib.Path</span>
<span class="sd">        File path of the shapefile to be rasterized.</span>
<span class="sd">    rst_out: pathlib.Path</span>
<span class="sd">        File path of the destination rst</span>
<span class="sd">    Cnst: dict</span>
<span class="sd">        Dictionary with following keys:</span>

<span class="sd">        - *res* (int): resolution</span>
<span class="sd">        - *nodata* (int): nodata flag</span>
<span class="sd">        - *minmax* (list): list with xmin, ymin, xmax, ymax</span>

<span class="sd">    rstval: str</span>
<span class="sd">        The value all features of the shapefile will get in the raster.</span>
<span class="sd">    alltouched: bool, default true</span>
<span class="sd">        Enables the ALL_TOUCHED rasterization option so that all pixels</span>
<span class="sd">        touched by lines or polygons will be updated.</span>
<span class="sd">    dtype: str, default None</span>
<span class="sd">        Data type of the values, e.g. Byte/Int16/UInt16/UInt32/Int32/Float32...</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>
<span class="sd">    Uses and relies on gdal_rasterize CLI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gdal_rasterize&quot;</span><span class="p">,</span> <span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="s2">&quot;-a_nodata&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nodata</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">alltouched</span><span class="p">:</span>
        <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-at&quot;</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-burn&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rstval</span><span class="p">)]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-l&quot;</span><span class="p">,</span> <span class="n">vct_in</span><span class="o">.</span><span class="n">stem</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-of&quot;</span><span class="p">,</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span> <span class="s2">&quot;-te&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">oor</span> <span class="ow">in</span> <span class="n">Cnst</span><span class="p">[</span><span class="s2">&quot;minmax&quot;</span><span class="p">]:</span>
        <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">oor</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-ot&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-tr&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Cnst</span><span class="p">[</span><span class="s2">&quot;res&quot;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">Cnst</span><span class="p">[</span><span class="s2">&quot;res&quot;</span><span class="p">])]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-co&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPRESS=DEFLATE&quot;</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vct_in</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_out</span><span class="p">)]</span>

    <span class="n">execute_subprocess</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="reclass_rst">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.reclass_rst">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">reclass_rst</span><span class="p">(</span><span class="n">rst_in</span><span class="p">,</span> <span class="n">rst_out</span><span class="p">,</span> <span class="n">df_reclass</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reclass of a raster based on pandas dataframe</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_in: str or pathlib.Path</span>
<span class="sd">        File path of the input raster</span>
<span class="sd">    rst_out: pathlib.Path</span>
<span class="sd">        File path of the destination rst (.sdat)</span>
<span class="sd">    df_reclass: pandas.DataFrame</span>
<span class="sd">        DataFrame containing the mapping with the columns:</span>

<span class="sd">        - *RST_VAL*: current values</span>
<span class="sd">        - *NEWVAL*: new value</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>
<span class="sd">    Uses and relies on saga_cmd CLI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_reclass</span><span class="p">[</span><span class="s2">&quot;MAX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_reclass</span><span class="p">[</span><span class="s2">&quot;RST_VAL&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">txt_reclass</span> <span class="o">=</span> <span class="n">rst_out</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="n">rst_out</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;_reclasstable.csv&quot;</span><span class="p">)</span>
    <span class="n">df_reclass</span><span class="p">[[</span><span class="s2">&quot;RST_VAL&quot;</span><span class="p">,</span> <span class="s2">&quot;MAX&quot;</span><span class="p">,</span> <span class="s2">&quot;NEWVAL&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">txt_reclass</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;saga_cmd&quot;</span><span class="p">,</span> <span class="n">SAGA_FLAGS</span><span class="p">,</span> <span class="s2">&quot;grid_tools&quot;</span><span class="p">,</span> <span class="s2">&quot;15&quot;</span><span class="p">,</span> <span class="s2">&quot;-INPUT&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_in</span><span class="p">)]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-RESULT&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_out</span><span class="p">),</span> <span class="s2">&quot;-METHOD&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;-RETAB_2&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">txt_reclass</span><span class="p">)]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span>
        <span class="s2">&quot;-F_MIN=RST_VAL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-F_MAX=MAX&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-F_CODE=NEWVAL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-TOPERATOR=0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-RESULT_NODATA_CHOICE=0&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">execute_saga</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="raster_to_polygon">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.raster_to_polygon">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">raster_to_polygon</span><span class="p">(</span><span class="n">rst_in</span><span class="p">,</span> <span class="n">vct_out</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Polygonize a raster</span>

<span class="sd">    This function converts rastercells to polygons</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_in: str or pathlib.Path</span>
<span class="sd">        File path of theinput raster</span>
<span class="sd">    vct_out: str or pathlib.Path</span>
<span class="sd">        File path of the destination shapefile</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>
<span class="sd">    Uses and relies on saga_cmd CLI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;saga_cmd&quot;</span><span class="p">,</span> <span class="n">SAGA_FLAGS</span><span class="p">,</span> <span class="s2">&quot;shapes_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">,</span> <span class="s2">&quot;-GRID&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_in</span><span class="p">)]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-POLYGONS&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_out</span><span class="p">),</span> <span class="s2">&quot;-CLASS_ALL&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;-SPLIT&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">]</span>
    <span class="n">execute_saga</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="lines_to_points">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.lines_to_points">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct_lines&quot;</span><span class="p">:</span> <span class="n">valid_linesvector</span><span class="p">,</span> <span class="s2">&quot;vct_points&quot;</span><span class="p">:</span> <span class="n">valid_pointvector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">lines_to_points</span><span class="p">(</span><span class="n">vct_lines</span><span class="p">,</span> <span class="n">vct_points</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a shapefile with lines to a shapefile with points.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct_lines: str or pathlib.Path</span>
<span class="sd">        File path to the input shapefile with lines.</span>
<span class="sd">    vct_points: str or pathlib.Path</span>
<span class="sd">        File path to the output shapefile with points.</span>
<span class="sd">    distance: float</span>
<span class="sd">        Distance between two points</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>
<span class="sd">    Uses and relies on saga_cmd CLI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;saga_cmd&quot;</span><span class="p">,</span> <span class="n">SAGA_FLAGS</span><span class="p">,</span> <span class="s2">&quot;shapes_points&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-LINES&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_lines</span><span class="p">),</span> <span class="s2">&quot;-POINTS&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_points</span><span class="p">)]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-ADD&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;-METHOD_INSERT&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;-DIST&quot;</span><span class="p">,</span> <span class="n">distance</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-ADD_POINT_ORDER&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">]</span>

    <span class="n">execute_saga</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="lines_to_direction">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.lines_to_direction">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct_line&quot;</span><span class="p">:</span> <span class="n">valid_linesvector</span><span class="p">,</span> <span class="s2">&quot;rst_template&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">lines_to_direction</span><span class="p">(</span><span class="n">vct_line</span><span class="p">,</span> <span class="n">rst_out</span><span class="p">,</span> <span class="n">rst_template</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts line features to a direction raster</span>

<span class="sd">    This function converts the direction of line features to a raster. See the</span>
<span class="sd">    :ref:`docs of cnws for more information &lt;watemsedem:routingmap&gt;` about this raster</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct_line: str or pathlib.Path</span>
<span class="sd">        File path to the input line shapefile</span>
<span class="sd">    rst_out: pathlib.Path</span>
<span class="sd">        File path to the output raster</span>
<span class="sd">    rst_template: str or pathlib.Path</span>
<span class="sd">        File path to a template raster</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>
<span class="sd">    Uses and relies on saga_cmd CLI</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;saga_cmd&quot;</span><span class="p">,</span> <span class="n">SAGA_FLAGS</span><span class="p">,</span> <span class="s2">&quot;line_direction&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span>
        <span class="s2">&quot;-INPUT&quot;</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">vct_line</span><span class="p">),</span>
        <span class="s2">&quot;-TARGET_DEFINITION&quot;</span><span class="p">,</span>
        <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-TARGET_TEMPLATE&quot;</span><span class="p">,</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">rst_template</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-GRID&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_out</span><span class="p">),</span> <span class="s2">&quot;-ORDER_FIELD&quot;</span><span class="p">,</span> <span class="s2">&quot;sort_order&quot;</span><span class="p">]</span>

    <span class="n">execute_saga</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>

    <span class="n">rst_out</span> <span class="o">=</span> <span class="n">rst_out</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="n">rst_out</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;.sdat&quot;</span><span class="p">)</span>

    <span class="n">arr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">load_raster</span><span class="p">(</span><span class="n">rst_out</span><span class="p">)</span>
    <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;compress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DEFLATE&quot;</span>
    <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;nodata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">arr</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr</span> <span class="o">==</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int16&quot;</span><span class="p">)</span>
    <span class="n">write_arr_as_rst</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">rst_out</span><span class="p">,</span> <span class="s2">&quot;int16&quot;</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="check_single_polygon">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.check_single_polygon">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct&quot;</span><span class="p">:</span> <span class="n">valid_vector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">check_single_polygon</span><span class="p">(</span><span class="n">vct</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the catchment polygon is a single polygon (not empty or</span>
<span class="sd">    multipolygon).</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    vct: str or pathlib.Path</span>
<span class="sd">        File path of the shapefile</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vct</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">nr_polygons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nr_polygons</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Catchment polygon should be a single polygon, current &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;catchment polygon holds &#39;</span><span class="si">{</span><span class="n">nr_polygons</span><span class="si">}</span><span class="s2">&#39; polygons.&quot;</span>
            <span class="p">)</span>
            <span class="ne">IOError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="vct_to_rst_field">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.vct_to_rst_field">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct_in&quot;</span><span class="p">:</span> <span class="n">valid_vector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">vct_to_rst_field</span><span class="p">(</span>
    <span class="n">vct_in</span><span class="p">,</span> <span class="n">rst_out</span><span class="p">,</span> <span class="n">Cnst</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alltouched</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;Float64&quot;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rasterizes a shapefile by a given attribute field</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct_in: str or pathlib.Path</span>
<span class="sd">        File path of the shapefile to be rasterized.</span>
<span class="sd">    rst_out: pathlib.Path</span>
<span class="sd">        File path of the destination rst</span>
<span class="sd">    Cnst: dict</span>
<span class="sd">        Dictionary with following keys:</span>

<span class="sd">        - *res* (int): resolution</span>
<span class="sd">        - *nodata* (int): nodata flag</span>
<span class="sd">        - *minmax* (list): list with xmin, ymin, xmax, ymax</span>

<span class="sd">    field: str</span>
<span class="sd">        The field of the shapefile containing the values for the raster</span>
<span class="sd">    alltouched: bool, default True</span>
<span class="sd">        Enables the ALL_TOUCHED rasterization option so that all pixels</span>
<span class="sd">        touched by lines or polygons will be updated.</span>
<span class="sd">    dtype: str, default None</span>
<span class="sd">        Data type of the values, e.g. Byte/Int16/UInt16/UInt32/Int32/Float32...</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Uses and relies on gdal_rasterize CLI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># if rst_out.exists():</span>
    <span class="c1">#    delete_rst(rst_out)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rst_out</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">rst_out</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">rst_out</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">rst_out</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rst_out</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">rst_out</span> <span class="o">=</span> <span class="n">rst_out</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="n">rst_out</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;.tif&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;outrst&#39; is of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">rst_out</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;can not be converted to Pathlib Path&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vct_in</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">vct_in</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">vct_in</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">vct_in</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;.shp&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vct_in</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
        <span class="n">vct_in</span> <span class="o">=</span> <span class="n">vct_in</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="p">(</span><span class="n">vct_in</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;.shp&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;inshp&#39; is of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">vct_in</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;can not be converted to Pathlib Path&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gdal_rasterize&quot;</span><span class="p">,</span> <span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="s2">&quot;-a_nodata&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Cnst</span><span class="p">[</span><span class="s2">&quot;nodata&quot;</span><span class="p">])]</span>
    <span class="k">if</span> <span class="n">alltouched</span><span class="p">:</span>
        <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-at&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
        <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-a&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-l&quot;</span><span class="p">,</span> <span class="n">vct_in</span><span class="o">.</span><span class="n">stem</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-of&quot;</span><span class="p">,</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span> <span class="s2">&quot;-te&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">oor</span> <span class="ow">in</span> <span class="n">Cnst</span><span class="p">[</span><span class="s2">&quot;minmax&quot;</span><span class="p">]:</span>
        <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">oor</span><span class="p">)]</span>

    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-ot&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-tr&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">Cnst</span><span class="p">[</span><span class="s2">&quot;res&quot;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">Cnst</span><span class="p">[</span><span class="s2">&quot;res&quot;</span><span class="p">])]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-co&quot;</span><span class="p">,</span> <span class="s2">&quot;COMPRESS=DEFLATE&quot;</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vct_in</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_out</span><span class="p">)]</span>

    <span class="n">execute_subprocess</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="execute_saga">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.execute_saga">[docs]</a>
<span class="k">def</span> <span class="nf">execute_saga</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run saga executable and catch non-informative error</span>

<span class="sd">    This function catches saga error command and ignores &#39;corrupted size vs. prev_size</span>
<span class="sd">    in fastbins&#39; error in case output runs from saga are okay.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    saga_cmd: list</span>
<span class="sd">        Saga command</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;saga_cmd&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd_args</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span><span class="si">}</span><span class="s2"> is not a saga command.&quot;</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;corrupted size vs. prev_size in fastbins&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="s2">&quot;okay&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span></div>



<div class="viewcode-block" id="polygons_to_raster">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.polygons_to_raster">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct_polygon&quot;</span><span class="p">:</span> <span class="n">valid_polygonvector</span><span class="p">,</span> <span class="s2">&quot;rst_template&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">polygons_to_raster</span><span class="p">(</span><span class="n">vct_polygon</span><span class="p">,</span> <span class="n">rst_out</span><span class="p">,</span> <span class="n">rst_template</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a polygon shapefile to a raster</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct_polygon: str or pathlib.Path</span>
<span class="sd">        File path of input polygon shapefile</span>
<span class="sd">    rst_out: str or pathlib.Path</span>
<span class="sd">        File path of output rasterfile</span>
<span class="sd">    rst_template: str or pathlib.Path</span>
<span class="sd">        File path to a template raster</span>
<span class="sd">    field: str</span>
<span class="sd">        The field of the shapefile containing the values for the raster</span>
<span class="sd">    dtype: str, default None</span>
<span class="sd">        Data type of the values, e.g. Byte/Int16/UInt16/UInt32/Int32/Float32...</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>
<span class="sd">    Uses and relies on saga_cmd CLI</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;saga_cmd&quot;</span><span class="p">,</span> <span class="n">SAGA_FLAGS</span><span class="p">,</span> <span class="s2">&quot;grid_gridding&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-INPUT&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_polygon</span><span class="p">),</span> <span class="s2">&quot;-FIELD&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-OUTPUT&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;-POLY_TYPE&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;integer&quot;</span><span class="p">:</span>
        <span class="n">grid_type</span> <span class="o">=</span> <span class="s2">&quot;6&quot;</span>  <span class="c1"># 4 byte unsigned integer</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;float&quot;</span><span class="p">:</span>
        <span class="n">grid_type</span> <span class="o">=</span> <span class="s2">&quot;7&quot;</span>  <span class="c1"># 4 byte floating point</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grid_type</span> <span class="o">=</span> <span class="s2">&quot;9&quot;</span>  <span class="c1"># same as attribute</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-GRID_TYPE&quot;</span><span class="p">,</span> <span class="n">grid_type</span><span class="p">,</span> <span class="s2">&quot;-TARGET_DEFINITION&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-TARGET_TEMPLATE&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_template</span><span class="p">),</span> <span class="s2">&quot;-GRID&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_out</span><span class="p">)]</span>
    <span class="n">execute_saga</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="lines_to_raster">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.lines_to_raster">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct_line&quot;</span><span class="p">:</span> <span class="n">valid_linesvector</span><span class="p">,</span> <span class="s2">&quot;rst_template&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">lines_to_raster</span><span class="p">(</span><span class="n">vct_line</span><span class="p">,</span> <span class="n">rst_out</span><span class="p">,</span> <span class="n">rst_template</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a line shapefile to a raster</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct_line: str or pathlib.Path</span>
<span class="sd">        File path of input line shapefile</span>
<span class="sd">    rst_out: str or pathlib.Path</span>
<span class="sd">        File path of output rasterfile</span>
<span class="sd">    rst_template: str or pathlib.Path</span>
<span class="sd">        File path to a template raster</span>
<span class="sd">    field: str</span>
<span class="sd">        The field of the shapefile containing the values for the raster</span>
<span class="sd">    dtype: str, default None</span>
<span class="sd">        Data type of the values, e.g. Byte/Int16/UInt16/UInt32/Int32/Float32...</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>
<span class="sd">    Uses and relies on saga_cmd CLI</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;saga_cmd&quot;</span><span class="p">,</span> <span class="n">SAGA_FLAGS</span><span class="p">,</span> <span class="s2">&quot;grid_gridding&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-INPUT&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_line</span><span class="p">),</span> <span class="s2">&quot;-FIELD&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-OUTPUT&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;-LINE_TYPE&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;integer&quot;</span><span class="p">:</span>
        <span class="n">grid_type</span> <span class="o">=</span> <span class="s2">&quot;6&quot;</span>  <span class="c1"># 4 byte unsigned integer</span>
    <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s2">&quot;float&quot;</span><span class="p">:</span>
        <span class="n">grid_type</span> <span class="o">=</span> <span class="s2">&quot;7&quot;</span>  <span class="c1"># 4 byte floating point</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">grid_type</span> <span class="o">=</span> <span class="s2">&quot;9&quot;</span>  <span class="c1"># same as attribute</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-GRID_TYPE&quot;</span><span class="p">,</span> <span class="n">grid_type</span><span class="p">,</span> <span class="s2">&quot;-TARGET_DEFINITION&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-TARGET_TEMPLATE&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_template</span><span class="p">),</span> <span class="s2">&quot;-GRID&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rst_out</span><span class="p">)]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">execute_subprocess</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;corrupted size vs. prev_size in fastbins&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>

                <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rst_out</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.sdat&quot;</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">RasterioIOError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_spatial_index">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.create_spatial_index">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct_in&quot;</span><span class="p">:</span> <span class="n">valid_vector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">create_spatial_index</span><span class="p">(</span><span class="n">vct_in</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a qix-file for a given shapefile</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct_in: str or pathlib.Path</span>
<span class="sd">        File path of the input shapefile</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>
<span class="sd">    Uses and relies on ogrinfo CLI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">vct_in</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ogrinfo&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_in</span><span class="p">)]</span>
        <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-q&quot;</span><span class="p">,</span> <span class="s2">&quot;-sql&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;CREATE SPATIAL INDEX ON </span><span class="si">{</span><span class="n">vct_in</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
        <span class="n">execute_subprocess</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Shapefile does not exist! (</span><span class="si">{</span><span class="n">vct_in</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span></div>



<div class="viewcode-block" id="load_raster">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.load_raster">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">load_raster</span><span class="p">(</span><span class="n">rst</span><span class="p">,</span> <span class="n">return_bounds</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;load raster with rasterio</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst: str or pathlib.Path</span>
<span class="sd">        File path of the file, .rst arr.</span>
<span class="sd">    return_bounds: bool, default False</span>
<span class="sd">        Flag to indicate whether a bounds of the arr should be returned.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    arr: numpy.ndarray</span>
<span class="sd">        Array format of raster file.</span>
<span class="sd">    bounds: list</span>
<span class="sd">        List of bounds (xmin,ymin,xmax,ymax).</span>
<span class="sd">    profile: rasterio.profiles</span>
<span class="sd">        See :class:`rasterio.profiles.Profile`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># load</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rst</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span>
            <span class="k">if</span> <span class="n">return_bounds</span><span class="p">:</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">bounds</span>
    <span class="k">except</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">RasterioIOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;could not open </span><span class="si">{</span><span class="n">rst</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_bounds</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arr</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">bounds</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arr</span><span class="p">,</span> <span class="n">profile</span></div>



<div class="viewcode-block" id="raster_array_to_pandas_dataframe">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.raster_array_to_pandas_dataframe">[docs]</a>
<span class="k">def</span> <span class="nf">raster_array_to_pandas_dataframe</span><span class="p">(</span><span class="n">arr_raster</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a raster array to a pandas dataframe.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr_raster: numpy.ndarray</span>
<span class="sd">        Array raster format</span>
<span class="sd">    profile: rasterio.profiles</span>
<span class="sd">        See :class:`rasterio.profiles.Profile`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df: pandas.DataFrame</span>
<span class="sd">        A pandas format of the array raster with</span>

<span class="sd">        - *row* (int): the row id</span>
<span class="sd">        - *col* (int): the column id</span>
<span class="sd">        - *val* (float): the value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span>
    <span class="c1"># convert to list</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="n">nrows</span> <span class="o">*</span> <span class="n">ncols</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">arr</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr_raster</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">arr</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nrows</span><span class="p">)</span>
    <span class="n">arr</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ncols</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="s2">&quot;col&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="raster_dataframe_to_arr">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.raster_dataframe_to_arr">[docs]</a>
<span class="k">def</span> <span class="nf">raster_dataframe_to_arr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a pandas dataframe column to an array</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df: pandas.DataFrame</span>
<span class="sd">        A pandas format of the array raster with</span>

<span class="sd">        - *row* (int): the row id</span>
<span class="sd">        - *col* (int): the column id</span>
<span class="sd">        - *val* (float): the value</span>

<span class="sd">    profile: rasterio.profiles</span>
<span class="sd">        See :class:`rasterio.profiles.Profile`</span>
<span class="sd">    col: str</span>
<span class="sd">        Column name to convert to raster</span>
<span class="sd">    dtype: numpy.dtype</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    arr: numpy.ndarray</span>
<span class="sd">        Array of dataframe columns &#39;val&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nrows</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>
    <span class="n">ncols</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> not in list of raster&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;row&quot;</span><span class="p">,</span> <span class="s2">&quot;col&quot;</span><span class="p">])</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">arr</span></div>



<div class="viewcode-block" id="saga_intersection">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.saga_intersection">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct_a&quot;</span><span class="p">:</span> <span class="n">valid_vector</span><span class="p">,</span> <span class="s2">&quot;vct_b&quot;</span><span class="p">:</span> <span class="n">valid_vector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">saga_intersection</span><span class="p">(</span><span class="n">vct_a</span><span class="p">,</span> <span class="n">vct_b</span><span class="p">,</span> <span class="n">vct_intersect</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the intersection between two shapefiles</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct_a: str or pathlib.Path</span>
<span class="sd">        File path of input shapefile 1</span>
<span class="sd">    vct_b: str or pathlib.Path</span>
<span class="sd">        File path of input shapefile 2</span>
<span class="sd">    vct_intersect: str or pathlib.Path</span>
<span class="sd">        File path of the calculated intersection shapefile</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>
<span class="sd">    Uses and relies on saga_cmd CLI</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;saga_cmd&quot;</span><span class="p">,</span> <span class="n">SAGA_FLAGS</span><span class="p">,</span> <span class="s2">&quot;shapes_polygons&quot;</span><span class="p">,</span> <span class="s2">&quot;14&quot;</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-A&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_a</span><span class="p">)]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-B&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_b</span><span class="p">)]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-RESULT&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_intersect</span><span class="p">)]</span>

    <span class="n">execute_saga</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="write_area_ha_to_vct">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.write_area_ha_to_vct">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct&quot;</span><span class="p">:</span> <span class="n">valid_vector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">write_area_ha_to_vct</span><span class="p">(</span><span class="n">vct</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a field &#39;AREA_HA&#39; to a shapefile</span>

<span class="sd">    This function calculates the area of every feature in a shapefile in hectare</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct: str or pathlib.Path</span>
<span class="sd">        File path to the input shapefile</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gdf</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vct</span><span class="p">)</span>
    <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;AREA_HA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="mf">100.0</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">gdf</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">vct</span><span class="p">)</span></div>



<div class="viewcode-block" id="add_length_lines_to_polygons">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.add_length_lines_to_polygons">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct_lines&quot;</span><span class="p">:</span> <span class="n">valid_linesvector</span><span class="p">,</span> <span class="s2">&quot;vct_polygons&quot;</span><span class="p">:</span> <span class="n">valid_polygonvector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">add_length_lines_to_polygons</span><span class="p">(</span><span class="n">vct_lines</span><span class="p">,</span> <span class="n">vct_polygons</span><span class="p">,</span> <span class="n">vct_out</span><span class="p">,</span> <span class="n">name_field</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the total length of line segments within a polygon</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct_lines: str or pathlib.Path</span>
<span class="sd">        File path of the input line shapefile</span>
<span class="sd">    vct_polygons: str or pathlib.Path</span>
<span class="sd">        File path of the input polygon shapefile</span>
<span class="sd">    vct_out: str or pathlib.Path</span>
<span class="sd">        File path of the output polygon shapefile</span>
<span class="sd">    name_field: str</span>
<span class="sd">        Attribute name containing the lenght of the lines within a polygon</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gdf_lines</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vct_lines</span><span class="p">)</span>
    <span class="n">gdf_poly</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vct_polygons</span><span class="p">)</span>
    <span class="n">gdf_lines</span> <span class="o">=</span> <span class="n">gdf_lines</span><span class="p">[[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]]</span>
    <span class="n">gdf_lines</span><span class="p">[</span><span class="n">name_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdf_lines</span><span class="o">.</span><span class="n">length</span>
    <span class="n">sjoin</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">gdf_lines</span><span class="p">,</span> <span class="n">gdf_poly</span><span class="p">[[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="s2">&quot;within&quot;</span><span class="p">)</span>
    <span class="n">sjoin</span> <span class="o">=</span> <span class="n">sjoin</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;index_right&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">gdf_poly</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">gdf_poly</span><span class="p">,</span> <span class="n">sjoin</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">gdf_poly</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">vct_out</span><span class="p">)</span></div>



<div class="viewcode-block" id="grid_statistics">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.grid_statistics">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lst_rst&quot;</span><span class="p">:</span> <span class="n">valid_rasterlist</span><span class="p">,</span> <span class="s2">&quot;vct_in&quot;</span><span class="p">:</span> <span class="n">valid_polygonvector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">grid_statistics</span><span class="p">(</span>
    <span class="n">lst_rst</span><span class="p">,</span>
    <span class="n">vct_in</span><span class="p">,</span>
    <span class="n">vct_out</span><span class="p">,</span>
    <span class="n">naming</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">COUNT</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">MIN</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">MAX</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">RANGES</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">SUM</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">MEAN</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate zonal statistics for a raster based on polygons</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lst_rst: list</span>
<span class="sd">        File paths (str or pathlib.Path) of the input rasters</span>
<span class="sd">    vct_in: str or pathlib.Path</span>
<span class="sd">        File path of the input polygon shapefile</span>
<span class="sd">    vct_out: str or pathlib.Path</span>
<span class="sd">        File path of the output shapefile with the raster statistics</span>
<span class="sd">    naming: int, default 0</span>
<span class="sd">        1: grid name (note: esrsi shapes ar capped on 10 characters)</span>
<span class="sd">        0: grid id</span>
<span class="sd">    COUNT: bool, default False</span>
<span class="sd">        Count the raster cells within every polygon</span>
<span class="sd">    MIN: bool, default False</span>
<span class="sd">        Calculate the minimum value within every polygon</span>
<span class="sd">    MAX: bool, default False</span>
<span class="sd">        Calculate the maximum value within every polygon</span>
<span class="sd">    RANGES: bool, default False</span>
<span class="sd">        Calculate the range within every polygon</span>
<span class="sd">    SUM: bool, default False</span>
<span class="sd">        Calculate the sum of all pixel values within every polygon</span>
<span class="sd">    MEAN: bool, default False</span>
<span class="sd">        Calculate the mean of all pixel values within every polygon</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>
<span class="sd">    Uses and relies on saga_cmd CLI</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;saga_cmd&quot;</span><span class="p">,</span> <span class="n">SAGA_FLAGS</span><span class="p">,</span> <span class="s2">&quot;shapes_grid&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-GRIDS&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lst_rst</span><span class="p">])]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-NAMING&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">naming</span><span class="p">)]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-POLYGONS&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_in</span><span class="p">)]</span>
    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-RESULT&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_out</span><span class="p">)]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-COUNT&quot;</span><span class="p">,</span> <span class="s2">&quot;-MIN&quot;</span><span class="p">,</span> <span class="s2">&quot;-MAX&quot;</span><span class="p">,</span> <span class="s2">&quot;-RANGE&quot;</span><span class="p">,</span> <span class="s2">&quot;-SUM&quot;</span><span class="p">,</span> <span class="s2">&quot;-MEAN&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">opt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">COUNT</span><span class="p">,</span> <span class="n">MIN</span><span class="p">,</span> <span class="n">MAX</span><span class="p">,</span> <span class="n">RANGES</span><span class="p">,</span> <span class="n">SUM</span><span class="p">,</span> <span class="n">MEAN</span><span class="p">]):</span>
        <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">opt</span><span class="p">:</span>
            <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">]</span>

    <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-VAR&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;-STDDEV&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">]</span>
    <span class="n">execute_saga</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="mask_raster">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.mask_raster">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">,</span> <span class="s2">&quot;rst_mask&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">mask_raster</span><span class="p">(</span><span class="n">rst_in</span><span class="p">,</span> <span class="n">rst_mask</span><span class="p">,</span> <span class="n">un_id</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;masked&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mask a raster by setting no data with no data positions of mask</span>

<span class="sd">    The input raster is masked by the nodata value in the mask raster.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_in: str or pathlib.Path</span>
<span class="sd">        File path raster to be masked</span>
<span class="sd">    rst_mask: str  or pathlib.Path</span>
<span class="sd">        File path mask raster, see note for format</span>
<span class="sd">    un_id: int</span>
<span class="sd">        unique id of the raster</span>
<span class="sd">    folder: str, default &#39;masked&#39;</span>
<span class="sd">        Folder in which to safe masked raster</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rst_masker: str</span>
<span class="sd">        File path of masked raster</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    1. This mask raster should be a (**no** `nodata`, `nodata`)-raster in which the</span>
<span class="sd">       nodata  values indicate masking, and non-nodata values indicates not masking.</span>
<span class="sd">    2. Masking of the input raster is facilitated by setting to-mask-values in the</span>
<span class="sd">       input raster to `nodata`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">folder</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">():</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="n">arr_mask</span><span class="p">,</span> <span class="n">profile_mask</span> <span class="o">=</span> <span class="n">load_raster</span><span class="p">(</span><span class="n">rst_mask</span><span class="p">,</span> <span class="n">list_format</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">arr_in</span><span class="p">,</span> <span class="n">profile_in</span> <span class="o">=</span> <span class="n">load_raster</span><span class="p">(</span><span class="n">rst_in</span><span class="p">,</span> <span class="n">list_format</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">rst_masked</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">rst_in</span><span class="p">)</span>
    <span class="n">rst_masked</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;temp&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">rst_masked</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">un_id</span><span class="si">}{</span><span class="n">rst_masked</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">arr_in</span><span class="p">[</span><span class="n">arr_mask</span> <span class="o">==</span> <span class="n">profile_mask</span><span class="p">[</span><span class="s2">&quot;nodata&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">profile_in</span><span class="p">[</span><span class="s2">&quot;nodata&quot;</span><span class="p">]</span>
    <span class="n">write_arr_as_rst</span><span class="p">(</span><span class="n">arr_in</span><span class="p">,</span> <span class="n">rst_masked</span><span class="p">,</span> <span class="n">arr_in</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">profile_in</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rst_masked</span></div>



<div class="viewcode-block" id="merge_rasters">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.merge_rasters">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lst_rst&quot;</span><span class="p">:</span> <span class="n">valid_rasterlist</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">merge_rasters</span><span class="p">(</span><span class="n">lst_rst</span><span class="p">,</span> <span class="n">rst_out</span><span class="p">,</span> <span class="n">lst_rst_masks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge several rasters to one raster with option to mask input rasters</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lst_rst: list of str or list of pathlib.Path</span>
<span class="sd">        List of file paths of rasters which have to be merged together</span>
<span class="sd">    rst_out: str or pathlib.Path</span>
<span class="sd">        File path of merged raster</span>
<span class="sd">    lst_rst_masks: list</span>
<span class="sd">        List of file paths of mask files to be used to mask lst_rst_in, see</span>
<span class="sd">        :func:`pywatemsedem.geo.utils.mask_raster`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lst_rst_masks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lst_rst_temp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rst_in</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst_rst</span><span class="p">):</span>
            <span class="n">lst_rst_temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask_raster</span><span class="p">(</span><span class="n">rst_in</span><span class="p">,</span> <span class="n">lst_rst_masks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;temp&quot;</span><span class="p">))</span>
        <span class="n">lst_rst</span> <span class="o">=</span> <span class="n">lst_rst_temp</span>

    <span class="n">lst_src</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rst</span> <span class="ow">in</span> <span class="n">lst_rst</span><span class="p">:</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rst</span><span class="p">)</span>
        <span class="n">lst_src</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst_src</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mosaic</span><span class="p">,</span> <span class="n">out_trans</span> <span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">lst_src</span><span class="p">)</span>
        <span class="n">out_meta</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out_meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">,</span>
                <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="n">mosaic</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="n">mosaic</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="s2">&quot;transform&quot;</span><span class="p">:</span> <span class="n">out_trans</span><span class="p">,</span>
                <span class="s2">&quot;compress&quot;</span><span class="p">:</span> <span class="s2">&quot;DEFLATE&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rst_out</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">out_meta</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mosaic</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_discharge_file">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.load_discharge_file">[docs]</a>
<span class="k">def</span> <span class="nf">load_discharge_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to read the discharge file as a dictionary</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename: str or pathlib.Path</span>
<span class="sd">        discharge file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    discharge: dict</span>
<span class="sd">        contains discharge information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">discharge</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]:</span>
        <span class="n">discharge</span><span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;: &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; (&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">discharge</span></div>



<div class="viewcode-block" id="rasterprofile_to_rstparams">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.rasterprofile_to_rstparams">[docs]</a>
<span class="k">def</span> <span class="nf">rasterprofile_to_rstparams</span><span class="p">(</span><span class="n">profile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform rasterprofile to rstparams</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    profile: rasterio.profiles</span>
<span class="sd">        See :class:`rasterio.profiles.Profile`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rstparams: dict</span>
<span class="sd">        gdal dictionary holding all metadata for idrisi rasters</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rstparams</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;driver&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;GTiff&quot;</span>
    <span class="n">minmax</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;minmax&quot;</span><span class="p">]</span>
    <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">minmax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">minmax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;res&quot;</span><span class="p">]))</span>
    <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">((</span><span class="n">minmax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">minmax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;res&quot;</span><span class="p">]))</span>
    <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;crs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;epsg&quot;</span><span class="p">]</span>
    <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;transform&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">Affine</span><span class="p">(</span>
        <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;res&quot;</span><span class="p">],</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="n">minmax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="o">-</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;res&quot;</span><span class="p">],</span>
        <span class="n">minmax</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;nodata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;nodata&quot;</span><span class="p">]</span>
    <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;compress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DEFLATE&quot;</span>

    <span class="k">return</span> <span class="n">rstparams</span></div>



<div class="viewcode-block" id="rstparams_to_rasterprofile">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.rstparams_to_rasterprofile">[docs]</a>
<span class="k">def</span> <span class="nf">rstparams_to_rasterprofile</span><span class="p">(</span><span class="n">rstparams</span><span class="p">,</span> <span class="n">epsg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform rstparams dictionary to to rasterio rasterprofile dictionary</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    profile: rasterio.profiles</span>
<span class="sd">        See :class:`rasterio.profiles.Profile`</span>
<span class="sd">    epsg: str, default None</span>
<span class="sd">        The epsg code defining the coordinate system of the raster,</span>
<span class="sd">        format = &quot;EPSG:XXXXX&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rstparams: dict</span>
<span class="sd">        gdal dictionary holding all metadata for idrisi rasters</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;nodata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;nodata&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s2">&quot;init&quot;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;crs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;epsg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;crs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()[</span><span class="s2">&quot;init&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">epsg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;epsg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epsg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Cannot get epsg-code from rstparams, and no epsg defined!&quot;</span><span class="p">)</span>

    <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;res&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;transform&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">xmin</span> <span class="o">=</span> <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;transform&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;transform&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;transform&quot;</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">+</span> <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;transform&quot;</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>

    <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;minmax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]</span>
    <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;ncols&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span>
    <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;nrows&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">profile</span></div>



<div class="viewcode-block" id="set_no_data_rst">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.set_no_data_rst">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">set_no_data_rst</span><span class="p">(</span>
    <span class="n">rst_in</span><span class="p">,</span> <span class="n">rst_out</span><span class="p">,</span> <span class="n">arr_bindomain</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nodata_val</span><span class="o">=-</span><span class="mi">9999</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set all pixels of a raster outside the model domain equal to NoData</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_in: str</span>
<span class="sd">        File path of input raster to set no data values</span>
<span class="sd">    rst_out: str</span>
<span class="sd">        File path of output raster with no data values</span>
<span class="sd">    arr_bindomain: numpy.ndarray</span>
<span class="sd">        Array used to define domain nodata. In domain is equal to one,</span>
<span class="sd">        outside domain is equal to zero.</span>
<span class="sd">    profile: rasterio.profiles</span>
<span class="sd">        See :class:`rasterio.profiles.Profile`</span>
<span class="sd">    dtype: numpy.dtype, default None</span>
<span class="sd">        e.g. np.float64, np.float32, ..</span>
<span class="sd">    nodata_val: int, default -9999</span>
<span class="sd">        Standard value for nodata</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;nodata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodata_val</span>

    <span class="n">arr_out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_raster</span><span class="p">(</span><span class="n">rst_in</span><span class="p">)</span>
    <span class="n">arr_out</span><span class="p">[</span><span class="n">arr_bindomain</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;nodata&quot;</span><span class="p">]</span>

    <span class="n">arr_out</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">set_dtype_arr_rst</span><span class="p">(</span><span class="n">arr_out</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="n">write_arr_as_rst</span><span class="p">(</span><span class="n">arr_out</span><span class="p">,</span> <span class="n">rst_out</span><span class="p">,</span> <span class="n">arr_out</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span></div>



<div class="viewcode-block" id="valid_mask">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.valid_mask">[docs]</a>
<span class="k">def</span> <span class="nf">valid_mask</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if your input array mask is valid. Use as decorator&quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">arr_mask</span><span class="p">,</span> <span class="n">nodata</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper function</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        arr:</span>
<span class="sd">            See :func:`pywatemsedem.geo.rasters.AbstractRaster.mask`</span>
<span class="sd">        arr_mask:</span>
<span class="sd">            See :func:`pywatemsedem.geo.rasters.AbstractRaster.mask`</span>
<span class="sd">        nodata:</span>
<span class="sd">            See :func:`pywatemsedem.geo.rasters.AbstractRaster.mask`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check values mask</span>
        <span class="n">un_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">arr_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">un_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Mask array should have values 1 (no mask) and 0 (mask)&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(mask) values, instead of </span><span class="si">{</span><span class="n">un_mask</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># check if size input array is equal to mask array</span>
        <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">arr_mask</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Mask array has different size from input array&quot;</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># check if input array is not empty after masking</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">arr_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">nodata</span><span class="p">)</span> <span class="ow">or</span> <span class="n">arr</span><span class="p">[</span><span class="n">arr_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">cond</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Array after masking has only nodata values/is empty. Please check &quot;</span>
                <span class="s2">&quot;your mask/input array.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">arr_mask</span><span class="p">,</span> <span class="n">nodata</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span></div>



<div class="viewcode-block" id="set_no_data_arr">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.set_no_data_arr">[docs]</a>
<span class="nd">@valid_mask</span>
<span class="k">def</span> <span class="nf">set_no_data_arr</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">arr_mask</span><span class="p">,</span> <span class="n">nodata</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set no data to values to raster array outside mask.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr: numpy.ndarray</span>
<span class="sd">        To mask array</span>
<span class="sd">    arr_mask: numpy.ndarray</span>
<span class="sd">        Mask array</span>
<span class="sd">    nodata: float</span>
<span class="sd">        The no data value to set in input array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">nodata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arr</span></div>



<div class="viewcode-block" id="set_dtype_arr_rst">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.set_dtype_arr_rst">[docs]</a>
<span class="k">def</span> <span class="nf">set_dtype_arr_rst</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">profile</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set type for an array</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr: numpy.ndarray</span>
<span class="sd">        arr of a raster for which dtype has to be changed</span>
<span class="sd">    profile: rasterio.profiles</span>
<span class="sd">        See :class:`rasterio.profiles.Profile`</span>
<span class="sd">    dtype: numpy.dtype, default None</span>
<span class="sd">        e.g. np.float64, np.float32, ..</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    arr: numpy.ndarray</span>
<span class="sd">        dtype-updated arr of a raster for which dtype has to be changed</span>
<span class="sd">    profile: rasterio.profiles</span>
<span class="sd">        See :class:`rasterio.profiles.Profile` with update dtype geo medata information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;dtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dtype</span>

    <span class="k">return</span> <span class="n">arr</span><span class="p">,</span> <span class="n">profile</span></div>



<div class="viewcode-block" id="calculate_sum_rst">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.calculate_sum_rst">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">calculate_sum_rst</span><span class="p">(</span><span class="n">rst</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate sum of a raster values</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst: pathlib.Path</span>
<span class="sd">        File path of the raster file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float:</span>
<span class="sd">        sum of the values in the raster</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arr</span><span class="p">,</span> <span class="n">profile</span> <span class="o">=</span> <span class="n">load_raster</span><span class="p">(</span><span class="n">rst</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">arr</span> <span class="o">!=</span> <span class="n">profile</span><span class="p">[</span><span class="s2">&quot;nodata&quot;</span><span class="p">]])</span></div>



<div class="viewcode-block" id="get_rstparams">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.get_rstparams">[docs]</a>
<span class="k">def</span> <span class="nf">get_rstparams</span><span class="p">(</span><span class="n">CNWS_modelinputfolder</span><span class="p">,</span> <span class="n">epsg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">catchmentname</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get rstparams and rasterprofile from template raster (default:pkaart)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    CNWS_modelinputfolder: str or pathlib.Path</span>
<span class="sd">        the path to the CNWS_modelinputfolder</span>
<span class="sd">    epsg: str, default None</span>
<span class="sd">        the epsg code defining the coordinate system of the raster,</span>
<span class="sd">        format = &quot;EPSG:XXXXX&quot;</span>
<span class="sd">    catchmentname: str, default &quot;&quot;</span>
<span class="sd">        catchment name</span>
<span class="sd">    template: str or pathlib.Path, default None</span>
<span class="sd">        File path to a template file that can be used as template for</span>
<span class="sd">        geodata and bin mask. Default the &quot;P&quot; raster is used.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    profile: rasterio.profiles</span>
<span class="sd">        See :class:`rasterio.profiles.Profile`</span>
<span class="sd">    rstparams: dict</span>
<span class="sd">        gdal dictionary holding all metadata for idrisi rasters</span>
<span class="sd">    arr_bindomain: numpy.ndarray</span>
<span class="sd">        binary mask of modelling domain</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># this template is used to generate binair mask</span>
    <span class="k">if</span> <span class="n">template</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">CNWS_modelinputfolder</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;pfactor.rst&quot;</span>
    <span class="c1"># open and assign profile to rstparams</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Templatefile &#39;</span><span class="si">{</span><span class="n">template</span><span class="si">}</span><span class="s2">&#39; not known for getting spatial metadata &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&#39;rstparams&#39; and &#39;profile&#39;.&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="n">rstparams</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span>
    <span class="n">rstparams</span><span class="p">[</span><span class="s2">&quot;compress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DEFLATE&quot;</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">rstparams_to_rasterprofile</span><span class="p">(</span><span class="n">rstparams</span><span class="p">,</span> <span class="n">epsg</span><span class="o">=</span><span class="n">epsg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rstparams</span><span class="p">,</span> <span class="n">profile</span></div>



<div class="viewcode-block" id="get_mask_template">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.get_mask_template">[docs]</a>
<span class="k">def</span> <span class="nf">get_mask_template</span><span class="p">(</span><span class="n">CNWS_modelinputfolder</span><span class="p">,</span> <span class="n">catchmentname</span><span class="p">,</span> <span class="n">rst_template</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a binary raster from template raster (P-factor)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    CNWS_modelinputfolder: str or pathlib.Path</span>
<span class="sd">        File path to the CNWS_modelinputfolder</span>
<span class="sd">    catchmentname: str</span>
<span class="sd">        Catchment name</span>
<span class="sd">    rst_template: str or pathlib.Path, default None</span>
<span class="sd">        Path to a template file that can be used as template for geodata and bin mask</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    arr_bindomain: numpy.ndarray</span>
<span class="sd">        In domain is equal to one, outside domain is equal to zero.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">rst_template</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rst_template</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">CNWS_modelinputfolder</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;pfactor.rst&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">rst_template</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Templatefile &#39;</span><span class="si">{</span><span class="n">rst_template</span><span class="si">}</span><span class="s2">&#39; not known for getting spatial metadata&quot;</span>
            <span class="sa">f</span><span class="s2">&quot; &#39;rstparams&#39; and &#39;rasterprofile&#39;.&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="c1"># get bin_arr</span>
    <span class="n">arr_bindomain</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">arr_bindomain</span><span class="p">[</span><span class="n">arr_bindomain</span> <span class="o">!=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;nodata&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">arr_bindomain</span><span class="p">[</span><span class="n">arr_bindomain</span> <span class="o">==</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;nodata&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">arr_bindomain</span></div>



<div class="viewcode-block" id="any_equal_element_in_vector">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.any_equal_element_in_vector">[docs]</a>
<span class="k">def</span> <span class="nf">any_equal_element_in_vector</span><span class="p">(</span><span class="n">geoseries_left</span><span class="p">,</span> <span class="n">geoseries_right</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if there are equal vectors in the left and right geoseries</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    geoseries_left: geopandas.GeoSeries</span>
<span class="sd">    geoseries_right: geopandas.GeoSeries</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    bool</span>
<span class="sd">        Line strings present in left and right geoseries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">geoseries_left</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">geoseries_right</span><span class="o">.</span><span class="n">geom_equals</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="check_spatial_resolution_rst">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.check_spatial_resolution_rst">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;rst_in&quot;</span><span class="p">:</span> <span class="n">valid_raster</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">check_spatial_resolution_rst</span><span class="p">(</span><span class="n">rst_in</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the resolution of a tiff raster is equal to a defined one</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_in: str or pathlib.Path</span>
<span class="sd">        File path of input raster</span>
<span class="sd">    resolution: int</span>
<span class="sd">        Resolution to compare with</span>
<span class="sd">    precision: float, default 0.01</span>
<span class="sd">        Precision to check resolution</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cond: bool</span>
<span class="sd">        Equal/non-equal (True/False)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rst_in</span><span class="p">))</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">res_tif</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s2">&quot;transform&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">res_tif</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">precision</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resolution</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">precision</span><span class="p">):</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">cond</span></div>



<div class="viewcode-block" id="estimate_width_of_polygon">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.estimate_width_of_polygon">[docs]</a>
<span class="k">def</span> <span class="nf">estimate_width_of_polygon</span><span class="p">(</span>
    <span class="n">arr_polygon_perimeter</span><span class="p">,</span> <span class="n">arr_polygon_area</span><span class="p">,</span> <span class="n">nan_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate the width of a polygon with the length and area of the polygon</span>
<span class="sd">    see also</span>
<span class="sd">    https://gis.stackexchange.com/questions/20279/calculating-average-width-of-polygon/</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr_polygon_perimeter: numpy.ndarray or pandas.Series</span>
<span class="sd">        1D array holding in each row the perimeter of each polygon</span>
<span class="sd">    arr_polygon_area: numpy.ndarray or pandas.Series</span>
<span class="sd">        1D array holding in each row the area of each polygon</span>
<span class="sd">    nan_value: float</span>
<span class="sd">        The value to fill in for nan_values</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    arr_est_polygon_width: numpy.ndarray or pandas.Series</span>
<span class="sd">        1D array holding in each row the estimated width</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>

<span class="sd">    1. The width is only estimated for polygons which approximate a cuboid</span>
<span class="sd">    2. The width is estimated by</span>

<span class="sd">    .. math::</span>

<span class="sd">        B_gr =  1/4 [A-√(B-C)]</span>
<span class="sd">            1/4 [P_{poly}-√(〖P_{poly}〗^2-16A_{poly} )]</span>

<span class="sd">    with</span>

<span class="sd">    - :math:`P_{poly}` = perimeter of polygon</span>
<span class="sd">    - :math:`A_{poly}` = area of polygon</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    check_cuboid_condition</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">condition</span> <span class="o">=</span> <span class="n">check_cuboid_condition</span><span class="p">(</span><span class="n">arr_polygon_perimeter</span><span class="p">,</span> <span class="n">arr_polygon_area</span><span class="p">)</span>

    <span class="n">arr_est_polygon_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">condition</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">nan_value</span>

    <span class="n">arr_est_polygon_width</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">arr_polygon_perimeter</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span>
        <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="p">(</span><span class="n">arr_polygon_perimeter</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">arr_polygon_area</span><span class="p">[</span><span class="n">condition</span><span class="p">])</span>
        <span class="p">)</span>
    <span class="p">)</span> <span class="o">/</span> <span class="mi">4</span>

    <span class="k">return</span> <span class="n">arr_est_polygon_width</span></div>



<div class="viewcode-block" id="check_cuboid_condition">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.check_cuboid_condition">[docs]</a>
<span class="k">def</span> <span class="nf">check_cuboid_condition</span><span class="p">(</span><span class="n">arr_polygon_perimeter</span><span class="p">,</span> <span class="n">arr_polygon_area</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a shape can be classified as a cuboid</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr_polygon_perimeter: numpy.ndarray or pandas.Series</span>
<span class="sd">        1D array holding in each row the perimeter of each polygon</span>
<span class="sd">    arr_polygon_area: numpy.ndarray or pandas.Series</span>
<span class="sd">        1D array holding in each row the area of each polygon</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    condition: numpy.ndarray or pandas.Series</span>
<span class="sd">        1D array holding True/False if cuboid</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    estimate_width_of_polygon</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">condition</span> <span class="o">=</span> <span class="n">arr_polygon_perimeter</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">arr_polygon_area</span>

    <span class="k">return</span> <span class="n">condition</span></div>



<div class="viewcode-block" id="execute_subprocess">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.execute_subprocess">[docs]</a>
<span class="k">def</span> <span class="nf">execute_subprocess</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run a command line tool</span>

<span class="sd">    Logs error with command output and error</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cmd_args: list</span>
<span class="sd">        list with all argmunts that must be given to the console</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Returns True if function call is successfull.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not run &#39;</span><span class="si">{</span><span class="n">cmd_args</span><span class="si">}</span><span class="s2">&#39;, returning &#39;</span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;-error&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="clip_vct_with_bounds">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.clip_vct_with_bounds">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;vct_in&quot;</span><span class="p">:</span> <span class="n">valid_vector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">clip_vct_with_bounds</span><span class="p">(</span><span class="n">vct_in</span><span class="p">,</span> <span class="n">vct_out</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clip a shapefile using a bounding box</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct_in: pathlib.Path</span>
<span class="sd">        File path of shapefile to be clipped.</span>
<span class="sd">    vct_out: pathlib.Path</span>
<span class="sd">        File path of the destination shapefile</span>
<span class="sd">    bounds: list</span>
<span class="sd">        list with xmin, ymin, xmax, ymax</span>
<span class="sd">    overwrite: bool, default False</span>
<span class="sd">        if True, overwrite existing file</span>

<span class="sd">    Note</span>
<span class="sd">    -----</span>
<span class="sd">    Uses and relies on ogr2ogr CLI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cond</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vct_out</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">cond</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Clipping </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">vct_in</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;ogr2ogr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;-spat&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>
        <span class="p">]</span>
        <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;-skipfailures&quot;</span><span class="p">]</span>
        <span class="n">cmd_args</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vct_out</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">vct_in</span><span class="p">)]</span>
        <span class="n">execute_subprocess</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="define_extent_from_vct">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.define_extent_from_vct">[docs]</a>
<span class="nd">@valid_input</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;valid_catchment&quot;</span><span class="p">:</span> <span class="n">valid_polygonvector</span><span class="p">})</span>
<span class="k">def</span> <span class="nf">define_extent_from_vct</span><span class="p">(</span>
    <span class="n">vct_catchment</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">nodata</span><span class="p">,</span> <span class="n">epsg</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="mi">100</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read the extent of the catchment</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vct_catchment: str or pathlib.Path</span>
<span class="sd">        File path of the vector shapefile</span>
<span class="sd">    bounds: list, default None</span>
<span class="sd">        if None, bounds are determined from</span>
<span class="sd">        The **first** entry is **x_left**, the **second** entry is **y_lower**,</span>
<span class="sd">        the **third** entry is **x_right** and the **fourth** entry is **y_upper**</span>
<span class="sd">        [x_left, y_lower, x_right, y_upper].</span>
<span class="sd">    resolution: int</span>
<span class="sd">        Spatial resolution</span>
<span class="sd">    epsg: int</span>
<span class="sd">        EPSG code should be a numeric value, see https://epsg.io/.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rp: RasterProperties see :class:`pywatemsedem.geo.rasterproperties.RasterProperties`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">fiona</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vct_catchment</span><span class="p">)</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
        <span class="c1"># Get spatial extent of catchment.</span>
        <span class="n">extent</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">bounds</span>
        <span class="n">minmax</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">round</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">,</span>
            <span class="nb">round</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">,</span>
            <span class="nb">round</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">,</span>
            <span class="nb">round</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="n">buffer</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># xmin en ymin</span>
                <span class="n">rest</span> <span class="o">=</span> <span class="p">(</span><span class="n">minmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">%</span> <span class="n">resolution</span>
                <span class="k">if</span> <span class="n">rest</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">minmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">minmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">rest</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># xmax en ymax</span>
                <span class="n">rest</span> <span class="o">=</span> <span class="p">(</span><span class="n">minmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">bounds</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">])</span> <span class="o">%</span> <span class="n">resolution</span>
                <span class="k">if</span> <span class="n">rest</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">minmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">minmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">rest</span> <span class="o">+</span> <span class="n">resolution</span>

    <span class="n">rp</span> <span class="o">=</span> <span class="n">RasterProperties</span><span class="p">(</span><span class="n">minmax</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">nodata</span><span class="p">,</span> <span class="n">epsg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rp</span></div>



<div class="viewcode-block" id="clean_up_tempfiles">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.clean_up_tempfiles">[docs]</a>
<span class="k">def</span> <span class="nf">clean_up_tempfiles</span><span class="p">(</span><span class="n">temporary_file</span><span class="p">,</span> <span class="n">file_format</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean up extra generated tempfiles</span>

<span class="sd">    This function can be used to clean-up extra files (for example auxilary files)</span>
<span class="sd">    generated during a write of raster or vector file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    temporary_file: pathlib.Path | str</span>

<span class="sd">    file_format: {&quot;tiff&quot;,&quot;shp&quot;,&quot;rst&quot;,&quot;txt&quot;}</span>
<span class="sd">            format of the temporary files</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">temporary_file</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">temporary_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">temporary_file</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">temporary_file</span><span class="p">)</span> <span class="ow">is</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">_TemporaryFileWrapper</span><span class="p">:</span>
        <span class="n">temporary_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">temporary_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">temporary_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s2">&quot;tiff&quot;</span><span class="p">:</span>
        <span class="n">check_suffix</span> <span class="o">=</span> <span class="n">SUFFIXES_TIF</span>
    <span class="k">elif</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s2">&quot;rst&quot;</span><span class="p">:</span>
        <span class="n">check_suffix</span> <span class="o">=</span> <span class="n">SUFFIXES_RST</span>
    <span class="k">elif</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s2">&quot;shp&quot;</span><span class="p">:</span>
        <span class="n">check_suffix</span> <span class="o">=</span> <span class="n">SUFFIXES_SHP</span>
    <span class="k">elif</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s2">&quot;txt&quot;</span><span class="p">:</span>
        <span class="n">check_suffix</span> <span class="o">=</span> <span class="n">SUFFIXES_TXT</span>
    <span class="k">elif</span> <span class="n">file_format</span> <span class="o">==</span> <span class="s2">&quot;saga&quot;</span><span class="p">:</span>
        <span class="n">check_suffix</span> <span class="o">=</span> <span class="n">SUFFIXES_SAGA</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;File format &#39;</span><span class="si">{</span><span class="n">file_format</span><span class="si">}</span><span class="s2">&#39; not implemented, cannot execute.&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">check_suffix</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">temporary_file</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">filename</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span></div>



<div class="viewcode-block" id="generate_vct_mask_from_raster_mask">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.generate_vct_mask_from_raster_mask">[docs]</a>
<span class="k">def</span> <span class="nf">generate_vct_mask_from_raster_mask</span><span class="p">(</span><span class="n">rst_catchment</span><span class="p">,</span> <span class="n">vct_catchment</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a catchment fileshape from a raster file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rst_catchment: str or pathlib.Path</span>
<span class="sd">        Input raster format of the catchment (can be any type that can be read by</span>
<span class="sd">        rasterio)</span>

<span class="sd">    vct_catchment: str or pathlib.Path</span>
<span class="sd">        output shapefile format of the catchment</span>

<span class="sd">    resolution: int</span>
<span class="sd">        resolution of the model run</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">condition</span> <span class="o">=</span> <span class="n">check_spatial_resolution_rst</span><span class="p">(</span><span class="n">rst_catchment</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">condition</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Defined resolution &#39;</span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s2">&#39; is not the same as resolution &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;catchment raster &#39;</span><span class="si">{</span><span class="n">rst_catchment</span><span class="si">}</span><span class="s2">&#39;. Aborting run.&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="c1"># gdf_catchment = tiff_to_geopandas_df(rst_catchment, crs)</span>
    <span class="n">raster_to_polygon</span><span class="p">(</span><span class="n">rst_catchment</span><span class="p">,</span> <span class="n">vct_catchment</span><span class="p">)</span>
    <span class="n">gdf_catchment</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">vct_catchment</span><span class="p">)</span>
    <span class="n">gdf_catchment</span> <span class="o">=</span> <span class="n">process_mask_shape_from_raster_file</span><span class="p">(</span><span class="n">gdf_catchment</span><span class="p">)</span>
    <span class="n">gdf_catchment</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">vct_catchment</span><span class="p">))</span></div>



<div class="viewcode-block" id="process_mask_shape_from_raster_file">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.process_mask_shape_from_raster_file">[docs]</a>
<span class="k">def</span> <span class="nf">process_mask_shape_from_raster_file</span><span class="p">(</span><span class="n">gdf_catchment</span><span class="p">,</span> <span class="n">catchment_value</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process the geopandas shape format of the input raster</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    gdf_catchment: geopandas.GeoDataFrame</span>
<span class="sd">        dataframe holding the mask , possible in multiple polygons (rows)</span>
<span class="sd">    catchment_value: int, default 1</span>
<span class="sd">        value that is used to define catchment</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    gdf_catchment: geopandas.GeoDataFrame</span>
<span class="sd">        dissolved dataframe holding mask, in one polygon (row)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gdf_catchment</span> <span class="o">=</span> <span class="n">gdf_catchment</span><span class="p">[</span><span class="n">gdf_catchment</span><span class="p">[</span><span class="s2">&quot;VALUE&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">catchment_value</span><span class="p">]</span>
    <span class="n">gdf_catchment</span> <span class="o">=</span> <span class="n">gdf_catchment</span><span class="o">.</span><span class="n">dissolve</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;VALUE&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gdf_catchment</span></div>



<div class="viewcode-block" id="mask_array_with_val">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.mask_array_with_val">[docs]</a>
<span class="k">def</span> <span class="nf">mask_array_with_val</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask_val</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Masking array by a mask</span>

<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    arr: numpy.ndarray</span>
<span class="sd">        array of which values are masked</span>
<span class="sd">    mask: numpy.ndarray</span>
<span class="sd">        masking array with same dimensions as arr</span>
<span class="sd">    mask_val: float or int</span>
<span class="sd">            masking arr when mask is mask_val</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arr_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="n">mask_val</span><span class="p">,</span> <span class="n">arr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arr_masked</span></div>



<div class="viewcode-block" id="nearly_identical">
<a class="viewcode-back" href="../../../api/pywatemsedem.geo.html#pywatemsedem.geo.utils.nearly_identical">[docs]</a>
<span class="k">def</span> <span class="nf">nearly_identical</span><span class="p">(</span><span class="n">geoms</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.75</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify nearly identical geometries</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    geoms: geopandas.GeoSeries</span>
<span class="sd">    p: shapely.Geometry</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.Series</span>
<span class="sd">        True/False</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nearly</span> <span class="o">=</span> <span class="p">(</span><span class="n">geoms</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">p</span><span class="o">.</span><span class="n">area</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span>
    <span class="c1"># return index values where nearly is True</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">nearly</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">nearly</span><span class="p">])</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Fluves.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>